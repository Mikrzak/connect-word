<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connect Word</title>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="/public/style.css">
</head>
<body>

    <div id="loginScreen">

        <div id="titleDiv">
            <p style="font-size: 20px;" >Connect Word⠀⠀⠀⠀⠀⠀⠀⠀⠀</p>
            <p style="font-size: 11px;" id="searchingText">Searching... (reload page to cancel)</p>
            <p style="font-size: 11px;" id="errorText"></p>
        </div><br><br>

        <form id="form">
            <label for="nickInput">Nick</label>
            <input id="nickInput" autocomplete="off" type="text" maxlength="10"></input><br>
            <label for="roomInput">Room</label>
            <input id="roomInput" autocomplete="off" type="number" maxlength="10"></input><br>

            <button id="joinButton">Go!</button>
            <label for="joinButton">Press to join a lobby or host one of the same name</label>
        </form><br><br>

        <div id="tutorial">
            <p style="font-size: 19px">How to play?</p>
            <p>- Take turns dropping letters by clicking on a column on the board</p>
            <p>- Get points by creating words (colors don't matter)</p>
            <p>⠀or connecting 4 tiles in a row of the same color</p>
        </div>

        <div id="jaskier">
            <img src="public/jaskier.jpg"></img>
        </div>

    </div>

    <div id="gameScreen" style="display: none">

        <div id="gameInfo">
            <p id="namesText"></p>
            <p id="pointsText">0 points</p>
        </div>

        <ul id="buttonGridList" style="list-style-type: none;"></ul>

        <ul id="buttonHandList" style="list-style-type: none; line-height: 0px;"></ul>

        <ul id="buttonLetterList" style="list-style-type: none; line-height: 0px; position: absolute; left: 22vw; top: 94px; width: 30vw;"></ul>
    </div>

    <script>

    var h,w;

    var buttonGrid = []; // game grid
    var buttonBag = []; // letter bag
    var buttonHand = []; // letter hand

    for(var i = 0; i < h; i++){

        var rowArr = [];

        for(var j = 0; j < w; j++)
            rowArr.push(0);

        buttonGrid.push(rowArr);
    }

    var isRedTurn = true, chosenLetter = null;
    var waitingForServer = false;

    var points = 0;

    var socket = io();

    var loginScreen = document.getElementById('loginScreen');
    var gameScreen = document.getElementById('gameScreen');
    var form = document.getElementById('form');

    var nickInput = document.getElementById('nickInput');
    var roomInput = document.getElementById('roomInput');

    var searchingText = document.getElementById('searchingText');
    var errorText = document.getElementById('errorText');
    var namesText = document.getElementById('namesText');
    var pointsText = document.getElementById('pointsText');

    var buttonGridList = document.getElementById('buttonGridList');
    var buttonLetterList = document.getElementById('buttonLetterList');
    var buttonHandList = document.getElementById('buttonHandList');

    searchingText.style.display = "none";

    var isSearching = false;
    var nickname, color, myId;

    function getButtonGridPos(button){

        for(var i = 0; i < h; i++){
            for(var j = 0; j < w; j++){

                if(buttonGrid[i][j] == button)
                    return [i,j];
                }
            }
    }

    function trySendMoveRequest(){

        if(waitingForServer || (color == "red" && !isRedTurn) || (color != "red" && isRedTurn) || chosenLetterIndex == null)
            return;

        if(buttonHand[chosenLetterIndex].innerHTML == "⠀")
            return;

        var arr = getButtonGridPos(this);

        waitingForServer = true;
        //console.log(chosenLetterIndex);
        socket.emit("moveRequest", arr, chosenLetterIndex, myId);
    }

    function pickLetterIndex(){

        for(var i = 0; i < buttonHand.length; i++){
            if(buttonHand[i] == this){
                chosenLetterIndex = i;
                return;
            }
        }
    }

    form.addEventListener('submit', function(e) {

        e.preventDefault();

        if (!isSearching && nickInput.value && roomInput.value) {

            nickname = nickInput.value;
            socket.emit("joinRequest" ,nickInput.value, roomInput.value);
            searchingText.style.display = "block";
            isSearching = true;
        }
    });

    socket.on("startGame", (opponentName, myColor, isRedTurnServer, grid, letterBag, hand, id) => {

        console.log(1);

        loginScreen.style.display = "none";
        gameScreen.style.display = "block";
        namesText.innerText = "Playing as " + nickname + " against " + opponentName + ", color: " + myColor;

        color = myColor;
        isRedTurn = isRedTurnServer;
        buttonGrid = grid;
        myId = id;
        
        for(var i = 0; i < buttonGrid.length; i++){

            var rowElement = document.createElement('li');

            for(var j = 0; j < buttonGrid[0].length; j++){

                var button = document.createElement('button');
                //button.style = "width: 50px; height: 50px; font-size: 10px; font-family: 'Consolas'; background-color: 'GGGGGG';";
                button.innerHTML = " ";

                button.onclick = trySendMoveRequest;

                rowElement.appendChild(button);

                buttonGrid[i][j] = button;
            }

            buttonGridList.appendChild(rowElement);
        }

        h = buttonGrid.length;
        w = buttonGrid[0].length;

        for(var i = 0; i < letterBag[0].length; i++){

            var element = document.createElement('li');
            element.style.display = "inline";

            var button = document.createElement('button');
            button.id = "bagButton";

            //button.style = "width: 50px; height: 50px; font-size: 10px; font-family: 'Consolas'; background-color: 'GGGGGG';";

            //button.innerHTML = letterBag[0][i] + " " + letterBag[1][i];
            //button.onclick = null;

            element.appendChild(button);

            buttonLetterList.appendChild(element);

            buttonBag.push(button);
        }

        for(var i = 0; i < hand.length; i++){

            var element = document.createElement('li');
            element.style.display = "inline";

            var button = document.createElement('button');

            //button.style = "width: 50px; height: 50px; font-size: 10px; font-family: 'Consolas'; background-color: 'GGGGGG';";
            button.innerHTML = hand[i];
            button.onclick = pickLetterIndex;

            element.appendChild(button);

            buttonHandList.appendChild(element);

            buttonHand.push(button);
        }
        
    });

    socket.on("gridUpdate", (updatedGrid) => {

        //console.log(updatedGrid);

        for(var i = 0; i < h; i++){
            for(var j = 0; j < w; j++){

                if(updatedGrid[i][j][1] == null){
                    
                    buttonGrid[i][j].innerHTML = "⠀";
                    buttonGrid[i][j].style.backgroundColor = "";
                    buttonGrid[i][j].style.backgroundImage = "";
                }
                else{

                    buttonGrid[i][j].innerHTML = updatedGrid[i][j][0];

                    if(updatedGrid[i][j][1] == "red"){
                        buttonGrid[i][j].style.backgroundImage = "none";
                        buttonGrid[i][j].style.backgroundColor = "#FF3939";
                    }
                    else if(updatedGrid[i][j][1] == "blue"){
                        buttonGrid[i][j].style.backgroundImage = "none";
                        buttonGrid[i][j].style.backgroundColor = "#25A3FE";
                    }
                }
            }
        }
    });

    socket.on("turnUpdate", (isRedTurnServer) => {
        
        isRedTurn = isRedTurnServer;
        waitingForServer = false;
    });

    socket.on("bagUpdate", (letters, distribution) => {
        
        for(var i = 0; i < buttonBag.length; i++){

            var para = document.createElement("p");
            para.style = "font-size: 12px;";
            para.innerHTML = letters[i];

            var para1 = document.createElement("p");
            para1.style = "font-size: 8px; text-align: right;";
            para1.innerHTML = distribution[i];
            
            buttonBag[i].innerHTML = "";
            buttonBag[i].appendChild(para).appendChild(para1);
        }
    });

    socket.on("handUpdate", (hand) => {
        
        for(var i = 0; i < buttonHand.length; i++){

            if(hand[i] == undefined)
                buttonHand[i].innerHTML = "⠀";
            else
                buttonHand[i].innerHTML = hand[i];
        }
    });

    socket.on("pointsUpdate", (updatedPoints) => {
        
        pointsText.innerHTML = updatedPoints + " points";
    });

    socket.on("sameUsernameError", (msg) => {

        errorText.innerText = "A player connecting to the same room has the same username as you";
    });

    socket.on("resetServerWaitTime", (e) => {

        waitingForServer = false;
    });
    
    </script>

</body>
</html>